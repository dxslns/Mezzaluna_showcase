<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="icon" href="PNGs/favicon5.ico">
    <title>My Space</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #f0f0f0;
            padding: 20px;
            min-height: 100vh;
        }

        .section {
            background: rgba(20, 20, 25, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
        }

        .title-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .title-icon {
            width: 24px;
            height: 24px;
            background: #409CFF;
            border-radius: 6px;
        }

        .toggle-chevron {
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>');
            background-size: contain;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .toggle-chevron.collapsed {
            transform: rotate(-90deg);
        }

        /* Health Score Styles */
        .health-score-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .health-score-circle-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .health-score-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .ring-circle {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
        }

        .ring-background {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .ring-progress {
            stroke: #409CFF;
            stroke-dasharray: 565;
            stroke-dashoffset: 565;
            transition: stroke-dashoffset 1s ease;
        }

        .ring-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-value {
            font-size: 48px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
        }

        .score-label {
            font-size: 16px;
            color: #409CFF;
            margin-top: 5px;
            font-weight: 600;
        }

        .verdict-description {
            text-align: center;
            font-size: 16px;
            color: #888;
            font-weight: 500;
        }

        .health-score-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: max-height 0.3s ease;
            overflow: hidden;
            max-height: 1000px;
        }

        .health-score-details.collapsed {
            max-height: 0;
        }

        .score-category {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.07);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #ffffff;
        }

        .category-icon {
            font-size: 16px;
        }

        .category-score {
            font-weight: 700;
            font-size: 18px;
            color: #409CFF;
        }

        .score-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .score-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        .score-description {
            font-size: 13px;
            color: #888;
        }

        /* Calendar Styles */
        .calendar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.07);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .calendar-nav-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .streak-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .streak-fire {
            font-size: 24px;
        }

        .streak-fire.active {
            animation: flame-pulse 0.5s ease-in-out;
        }

        .streak-fire.inactive {
            opacity: 0.3;
        }

        .streak-count {
            color: #ffffff;
            font-weight: 600;
            font-size: 16px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-btn {
            background: rgba(64, 156, 255, 0.1);
            border: 1px solid rgba(64, 156, 255, 0.2);
            color: #409CFF;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            background: rgba(64, 156, 255, 0.2);
            transform: translateY(-1px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #888;
            padding: 10px;
            font-size: 14px;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(64, 156, 255, 0.2);
            transform: translateY(-1px);
        }

        .calendar-day.today {
            border-color: #409CFF;
            background: rgba(64, 156, 255, 0.1);
        }

        .calendar-day.saved {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.2);
        }

        .calendar-day-number {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .saved-day-checkmark {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #4CAF50;
            font-size: 12px;
        }

        .day-indicators {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        .indicator-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #409CFF;
        }

        .calendar-day.empty {
            visibility: hidden;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: rgba(20, 20, 25, 0.95);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .close-modal {
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .modal-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .modal-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: #ffffff;
            font-weight: 500;
        }

        .slider-value {
            color: #409CFF;
            font-weight: 600;
            background: rgba(64, 156, 255, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #409CFF;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(64, 156, 255, 0.3);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .notion-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 120px;
        }

        .notion-button:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-1px);
        }

        .notion-button.selected {
            background: rgba(64, 156, 255, 0.2);
            border-color: #409CFF;
            color: #409CFF;
            font-weight: 600;
        }

        .notion-button[data-negative="true"].selected {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
            color: #ff6b81;
        }

        .conditional-section {
            display: none;
        }

        .notion-textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #ffffff;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
        }

        .notion-textarea:focus {
            outline: none;
            border-color: #409CFF;
        }

        .save-day-btn {
            width: calc(100% - 40px);
            margin: 20px;
            background: linear-gradient(135deg, #409CFF, #2d87ff);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(64, 156, 255, 0.3);
        }

        .save-day-btn:hover {
            background: linear-gradient(135deg, #2d87ff, #1a74ff);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(64, 156, 255, 0.4);
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            animation: fadeInOut 3s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            font-weight: 500;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes flame-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .section {
                padding: 15px;
            }

            .calendar-header {
                flex-direction: column;
                align-items: stretch;
            }

            .calendar-nav-wrapper {
                justify-content: space-between;
            }

            .calendar-grid {
                gap: 4px;
            }

            .calendar-day {
                padding: 8px;
                min-height: 50px;
            }

            .calendar-day-number {
                font-size: 14px;
            }

            .button-group {
                flex-direction: column;
            }

            .notion-button {
                min-width: auto;
            }

            .modal-content {
                margin: 10px;
                max-height: 85vh;
            }

            .modal-section {
                padding: 15px;
            }
        }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è Health Score */
        :root {
            --excellent-color: #4CAF50;
            --good-color: #8BC34A;
            --fair-color: #FFC107;
            --poor-color: #F44336;
        }

        .sleep-category .score-fill {
            background-color: #2196F3;
        }

        .water-category .score-fill {
            background-color: #00BCD4;
        }

        .mood-category .score-fill {
            background-color: #9C27B0;
        }

        .activity-category .score-fill {
            background-color: #FF9800;
        }
    </style>
</head>
<body>
    <div class="section">
        <h2 class="section-title" id="health-score-title">
            <span class="title-text">
                <span class="title-icon"></span>
                Health Score
            </span>
            <span class="toggle-chevron" id="health-score-toggle"></span>
        </h2>
        <div class="health-score-container">
            <div class="health-score-circle-wrapper">
                <svg class="health-score-circle" viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="white" />
                            <stop offset="100%" stop-color="green" />
                        </linearGradient>
                    </defs>
                    <circle class="ring-circle ring-background" cx="100" cy="100" r="90" />
                    <circle class="ring-circle ring-progress" id="ring-progress" cx="100" cy="100" r="90" />
                </svg>
                <div class="ring-center">
                    <div class="score-value" id="health-score">-</div>
                    <div class="score-label" id="health-label">Loading...</div>
                </div>
            </div>
            <div id="health-verdict" class="verdict-description"></div>
            <div class="health-score-details" id="health-score-details"></div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">
            <span class="title-text">
                <span class="title-icon"></span>
                Daily Tracking
            </span>
        </h2>
        <div class="calendar">
            <div class="calendar-header">
                <div class="calendar-title" id="current-month-year">June 2023</div>
                <div class="calendar-nav-wrapper">
                    <div class="streak-container">
                        <div class="streak-fire" id="streak-fire">üî•</div>
                        <div class="streak-count" id="streak-count">0</div>
                    </div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" id="prev-month">Previous</button>
                        <button class="calendar-nav-btn" id="next-month">Next</button>
                    </div>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-days-header">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            </div>
            <div class="calendar-grid" id="calendar-days"></div>
        </div>
    </div>

    <div class="modal" id="day-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-day-title">Day Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-section" id="sleep-section">
                <div class="modal-section-title">Sleep</div>
                <div class="slider-container">
                    <label class="slider-label" for="sleep-slider">
                        <span>Hours Slept</span>
                        <span id="sleep-value" class="slider-value">7.0 hrs</span>
                    </label>
                    <input type="range" id="sleep-slider" min="0" max="14" step="0.1" value="7">
                </div>
                <div class="button-group" id="sleep-quality-buttons">
                    <button class="notion-button" data-value="">Slept Well</button>
                    <button class="notion-button" data-value="poor-sleep" data-negative="true">Poor Sleep</button>
                </div>
            </div>
            <div class="modal-section conditional-section" id="sleep-issues-section">
                <div class="modal-section-title">Sleep Issues</div>
                <div class="button-group" id="sleep-issues-buttons">
                    <button class="notion-button" data-value="insomnia" data-negative="true">Insomnia</button>
                    <button class="notion-button" data-value="early-wakeup" data-negative="true">Early Wakeup</button>
                    <button class="notion-button" data-value="fragmented-sleep" data-negative="true">Fragmented Sleep</button>
                    <button class="notion-button" data-value="difficulty-falling-asleep" data-negative="true">Difficulty Falling Asleep</button>
                    <button class="notion-button" data-value="non-restorative-sleep" data-negative="true">Non-Restorative Sleep</button>
                    <button class="notion-button" data-value="daytime-sleepiness" data-negative="true">Daytime Sleepiness</button>
                </div>
            </div>
            <div class="modal-section" id="water-section">
                <div class="modal-section-title">Water Intake</div>
                <div class="button-group" id="water-intake-buttons">
                    <button class="notion-button" data-value="optimal">Optimal</button>
                    <button class="notion-button" data-value="enough">Enough</button>
                    <button class="notion-button" data-value="little">Little</button>
                    <button class="notion-button" data-value="too-little" data-negative="true">Too Little</button>
                </div>
            </div>
            <div class="modal-section conditional-section" id="dehydration-section">
                <div class="modal-section-title">Dehydration Symptoms</div>
                <div class="button-group" id="dehydration-buttons">
                    <button class="notion-button" data-value="headache" data-negative="true">Headache</button>
                    <button class="notion-button" data-value="fatigue" data-negative="true">Fatigue</button>
                    <button class="notion-button" data-value="dry-skin-mucous" data-negative="true">Dry Skin & Mucous</button>
                    <button class="notion-button" data-value="poor-concentration" data-negative="true">Poor Concentration</button>
                </div>
            </div>
            <div class="modal-section" id="mood-section">
                <div class="modal-section-title">Mood</div>
                <div class="slider-container">
                    <label class="slider-label" for="mood-slider">
                        <span>How did you feel today? (1-10)</span>
                        <span id="mood-value" class="slider-value">5</span>
                    </label>
                    <input type="range" id="mood-slider" min="1" max="10" value="5">
                </div>
            </div>
            <div class="modal-section conditional-section" id="mood-related-section">
                <div class="modal-section-title">Mood Related</div>
                <div class="button-group" id="mood-related-buttons">
                    <button class="notion-button" data-value="stress" data-negative="true">Stress</button>
                    <button class="notion-button" data-value="anxiety" data-negative="true">Anxiety</button>
                    <button class="notion-button" data-value="apathy" data-negative="true">Apathy</button>
                    <button class="notion-button" data-value="depressive-episode" data-negative="true">Depressive Episode</button>
                    <button class="notion-button" data-value="irritability" data-negative="true">Irritability</button>
                    <button class="notion-button" data-value="social-isolation" data-negative="true">Social Isolation</button>
                    <button class="notion-button" data-value="mood-swings" data-negative="true">Mood Swings</button>
                </div>
            </div>
            <div class="modal-section" id="activity-level-section">
                <div class="modal-section-title">Activity Level</div>
                <div class="slider-container">
                    <label class="slider-label" for="activity-slider">
                        <span>How active were you today? (1-10)</span>
                        <span id="activity-value" class="slider-value">5</span>
                    </label>
                    <input type="range" id="activity-slider" min="1" max="10" value="5">
                </div>
            </div>
            <div class="modal-section conditional-section" id="activity-issues-section">
                <div class="modal-section-title">Activity Issues</div>
                <div class="button-group" id="activity-issues-buttons">
                    <button class="notion-button" data-value="sedentary-day" data-negative="true">Sedentary Day</button>
                    <button class="notion-button" data-value="overtraining" data-negative="true">Overtraining</button>
                    <button class="notion-button" data-value="bad-mood" data-negative="true">Bad Mood</button>
                    <button class="notion-button" data-value="reduced-metabolism" data-negative="true">Reduced Metabolism</button>
                    <button class="notion-button" data-value="muscle-weakness" data-negative="true">Muscle Weakness</button>
                    <button class="notion-button" data-value="increased-stress" data-negative="true">Increased Stress</button>
                    <button class="notion-button" data-value="chronic-fatigue" data-negative="true">Chronic Fatigue</button>
                </div>
            </div>
            <div class="modal-section" id="notes-section">
                <div class="modal-section-title">Notes</div>
                <textarea class="notion-textarea" id="day-notes" placeholder="Write your notes for the day..."></textarea>
            </div>
            <button class="save-day-btn" id="save-day-btn">Save Day</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // =================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø LOCALSTORAGE ===================
        const DAYS_STORAGE_KEY = 'health_tracker_days';
        const STREAK_STORAGE_KEY = 'health_tracker_streak';
        const LAST_SAVED_DATE_KEY = 'health_tracker_last_saved_date';

        // =================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø HEALTH SCORE ===================
        const HEALTH_SCORE_CONFIG = {
            sleep: {
                weight: 40,
                optimalHours: { min: 7, max: 8 },
                scores: {
                    optimal: 100,
                    good: 80,
                    fair: 60,
                    poor: 40,
                    veryPoor: 20
                },
                poorSleepPenalty: 30,
                symptomPenalty: 10
            },
            water: {
                weight: 20,
                scores: {
                    'optimal': 100,
                    'enough': 80,
                    'little': 40,
                    'too-little': 20
                },
                symptomPenalty: 15
            },
            mood: {
                weight: 20,
                scores: {
                    10: 100, 9: 90, 8: 80, 7: 70, 6: 60, 5: 50,
                    4: 40, 3: 30, 2: 20, 1: 10
                },
                lowMoodPenalty: 25,
                symptomPenalty: 10
            },
            activity: {
                weight: 20,
                optimalRange: { min: 5, max: 7 },
                scores: {
                    10: 90, 9: 85, 8: 80, 7: 75, 6: 70, 5: 65,
                    4: 55, 3: 45, 2: 35, 1: 25
                },
                lowActivityPenalty: 20,
                highActivityPenalty: 15,
                symptomPenalty: 10
            }
        };

        // =================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° LOCALSTORAGE ===================
        function getDaysFromStorage() {
            try {
                const days = localStorage.getItem(DAYS_STORAGE_KEY);
                return days ? JSON.parse(days) : {};
            } catch (error) {
                console.error('Error reading days from localStorage:', error);
                return {};
            }
        }

        function saveDayToStorage(date, dayData) {
            try {
                const days = getDaysFromStorage();
                days[date] = {
                    ...dayData,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(DAYS_STORAGE_KEY, JSON.stringify(days));
                return true;
            } catch (error) {
                console.error('Error saving day to localStorage:', error);
                return false;
            }
        }

        function getDayFromStorage(date) {
            const days = getDaysFromStorage();
            return days[date] || null;
        }

        function getStreakFromStorage() {
            try {
                const streakData = localStorage.getItem(STREAK_STORAGE_KEY);
                return streakData ? JSON.parse(streakData) : { currentStreak: 0, lastDate: null };
            } catch (error) {
                console.error('Error reading streak from localStorage:', error);
                return { currentStreak: 0, lastDate: null };
            }
        }

        function updateStreakInStorage(date) {
            try {
                const streakData = getStreakFromStorage();
                const today = new Date(date);
                const lastDate = streakData.lastDate ? new Date(streakData.lastDate) : null;
                
                let currentStreak = streakData.currentStreak;
                let streakIncremented = false;
                
                if (lastDate) {
                    const dayDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    
                    if (dayDiff === 1) {
                        // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –¥–Ω–∏
                        currentStreak++;
                        streakIncremented = true;
                    } else if (dayDiff > 1) {
                        // –ü—Ä–æ–ø—É—â–µ–Ω—ã –¥–Ω–∏
                        currentStreak = 1;
                    }
                    // dayDiff === 0: —Ç–æ—Ç –∂–µ –¥–µ–Ω—å, –Ω–µ –º–µ–Ω—è–µ–º streak
                } else {
                    // –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å
                    currentStreak = 1;
                    streakIncremented = true;
                }
                
                const newStreakData = {
                    currentStreak: currentStreak,
                    lastDate: today.toISOString().split('T')[0]
                };
                
                localStorage.setItem(STREAK_STORAGE_KEY, JSON.stringify(newStreakData));
                
                return {
                    success: true,
                    currentStreak: currentStreak,
                    streakIncremented: streakIncremented
                };
            } catch (error) {
                console.error('Error updating streak:', error);
                return { success: false, currentStreak: 0, streakIncremented: false };
            }
        }

        // =================== HEALTH SCORE –§–£–ù–ö–¶–ò–ò ===================
        function calculateSleepScore(sleepHours, sleepQuality, sleepIssues) {
            let baseScore = 0;

            if (!sleepHours) return 0;

            if (sleepHours >= 7 && sleepHours <= 8) {
                baseScore = HEALTH_SCORE_CONFIG.sleep.scores.optimal;
            } else if ((sleepHours >= 6 && sleepHours < 7) || (sleepHours > 8 && sleepHours <= 9)) {
                baseScore = HEALTH_SCORE_CONFIG.sleep.scores.good;
            } else if ((sleepHours >= 5 && sleepHours < 6) || (sleepHours > 9 && sleepHours <= 10)) {
                baseScore = HEALTH_SCORE_CONFIG.sleep.scores.fair;
            } else if (sleepHours >= 4 && sleepHours < 5) {
                baseScore = HEALTH_SCORE_CONFIG.sleep.scores.poor;
            } else {
                baseScore = HEALTH_SCORE_CONFIG.sleep.scores.veryPoor;
            }

            if (sleepQuality === 'poor-sleep') {
                baseScore -= HEALTH_SCORE_CONFIG.sleep.poorSleepPenalty;
            }

            if (sleepIssues && sleepIssues.length > 0) {
                const symptomPenalty = sleepIssues.length * HEALTH_SCORE_CONFIG.sleep.symptomPenalty;
                baseScore -= symptomPenalty;
            }

            return Math.max(0, Math.min(100, baseScore));
        }

        function calculateWaterScore(waterIntake, dehydrationSymptoms) {
            if (!waterIntake) return 0;
            let baseScore = HEALTH_SCORE_CONFIG.water.scores[waterIntake] || 50;
            if (dehydrationSymptoms && dehydrationSymptoms.length > 0) {
                const symptomPenalty = dehydrationSymptoms.length * HEALTH_SCORE_CONFIG.water.symptomPenalty;
                baseScore -= symptomPenalty;
            }
            return Math.max(0, Math.min(100, baseScore));
        }

        function calculateMoodScore(mood, moodRelated) {
            if (!mood) return 0;
            let baseScore = HEALTH_SCORE_CONFIG.mood.scores[mood] || 50;
            if (mood <= 4) baseScore -= HEALTH_SCORE_CONFIG.mood.lowMoodPenalty;
            if (moodRelated && moodRelated.length > 0) {
                const symptomPenalty = moodRelated.length * HEALTH_SCORE_CONFIG.mood.symptomPenalty;
                baseScore -= symptomPenalty;
            }
            return Math.max(0, Math.min(100, baseScore));
        }

        function calculateActivityScore(activityLevel, activityIssues) {
            if (!activityLevel) return 0;
            let baseScore = HEALTH_SCORE_CONFIG.activity.scores[activityLevel] || 50;
            if (activityLevel <= 3) baseScore -= HEALTH_SCORE_CONFIG.activity.lowActivityPenalty;
            if (activityLevel >= 8) baseScore -= HEALTH_SCORE_CONFIG.activity.highActivityPenalty;
            if (activityIssues && activityIssues.length > 0) {
                const symptomPenalty = activityIssues.length * HEALTH_SCORE_CONFIG.activity.symptomPenalty;
                baseScore -= symptomPenalty;
            }
            return Math.max(0, Math.min(100, baseScore));
        }

        function calculateHealthScore(dayData) {
            const sleepScore = calculateSleepScore(
                dayData.sleepHours,
                dayData.sleepQuality,
                dayData.sleepIssues
            );

            const waterScore = calculateWaterScore(
                dayData.waterIntake,
                dayData.dehydrationSymptoms
            );

            const moodScore = calculateMoodScore(
                dayData.mood,
                dayData.moodRelated
            );

            const activityScore = calculateActivityScore(
                dayData.activityLevel,
                dayData.activityIssues
            );

            const weightedSleep = sleepScore * (HEALTH_SCORE_CONFIG.sleep.weight / 100);
            const weightedWater = waterScore * (HEALTH_SCORE_CONFIG.water.weight / 100);
            const weightedMood = moodScore * (HEALTH_SCORE_CONFIG.mood.weight / 100);
            const weightedActivity = activityScore * (HEALTH_SCORE_CONFIG.activity.weight / 100);

            const overallScore = Math.round(weightedSleep + weightedWater + weightedMood + weightedActivity);

            return {
                overallScore,
                categories: [
                    {
                        name: 'Sleep',
                        score: sleepScore,
                        weight: HEALTH_SCORE_CONFIG.sleep.weight,
                        description: getSleepDescription(dayData.sleepHours, dayData.sleepQuality, dayData.sleepIssues),
                        icon: 'üò¥'
                    },
                    {
                        name: 'Water',
                        score: waterScore,
                        weight: HEALTH_SCORE_CONFIG.water.weight,
                        description: getWaterDescription(dayData.waterIntake, dayData.dehydrationSymptoms),
                        icon: 'üíß'
                    },
                    {
                        name: 'Mood',
                        score: moodScore,
                        weight: HEALTH_SCORE_CONFIG.mood.weight,
                        description: getMoodDescription(dayData.mood, dayData.moodRelated),
                        icon: 'üòä'
                    },
                    {
                        name: 'Activity',
                        score: activityScore,
                        weight: HEALTH_SCORE_CONFIG.activity.weight,
                        description: getActivityDescription(dayData.activityLevel, dayData.activityIssues),
                        icon: 'üèÉ'
                    }
                ],
                verdict: getVerdict(overallScore)
            };
        }

        function getSleepDescription(hours, quality, issues) {
            let desc = hours ? `${hours} hours` : 'No data';
            if (quality === 'poor-sleep') desc += ' (poor quality)';
            if (issues && issues.length > 0) desc += `, ${issues.length} issue(s)`;
            return desc;
        }

        function getWaterDescription(intake, symptoms) {
            let desc = intake ? intake.replace('-', ' ') : 'No data';
            if (symptoms && symptoms.length > 0) desc += `, ${symptoms.length} symptom(s)`;
            return desc;
        }

        function getMoodDescription(mood, related) {
            let desc = mood ? `${mood}/10` : 'No data';
            if (related && related.length > 0) desc += `, ${related.length} issue(s)`;
            return desc;
        }

        function getActivityDescription(level, issues) {
            let desc = level ? `${level}/10` : 'No data';
            if (issues && issues.length > 0) desc += `, ${issues.length} issue(s)`;
            return desc;
        }

        function getVerdict(score) {
            if (score >= 90) return { level: 'Excellent', description: 'Outstanding health habits!', color: '#4CAF50', emoji: 'üåü' };
            else if (score >= 80) return { level: 'Great', description: 'Very healthy lifestyle!', color: '#8BC34A', emoji: 'üí™' };
            else if (score >= 70) return { level: 'Good', description: 'Solid health metrics.', color: '#FFC107', emoji: 'üëå' };
            else if (score >= 60) return { level: 'Fair', description: 'Room for improvement.', color: '#FF9800', emoji: '‚öñÔ∏è' };
            else if (score >= 50) return { level: 'Needs Work', description: 'Focus on healthier choices.', color: '#F44336', emoji: 'üìâ' };
            else return { level: 'Poor', description: 'Significant improvements needed.', color: '#D32F2F', emoji: '‚ö†Ô∏è' };
        }

        function getScoreColor(score) {
            if (score >= 80) return 'var(--excellent-color)';
            if (score >= 60) return 'var(--good-color)';
            if (score >= 40) return 'var(--fair-color)';
            return 'var(--poor-color)';
        }

        // =================== UI –§–£–ù–ö–¶–ò–ò ===================
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let selectedDay = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        let currentMonthYear, calendarDays, dayModal, modalDayTitle, closeModal;
        let sleepSlider, sleepValueDisplay, sleepQualityButtons;
        let waterIntakeButtons, moodSlider, moodValueDisplay, activitySlider, activityValueDisplay;
        let dayNotes, saveDayBtn;
        let sleepIssuesSection, dehydrationSection, moodRelatedSection, activityIssuesSection;
        let sleepIssuesButtons, dehydrationButtons, moodRelatedButtons, activityIssuesButtons;
        let prevMonthBtn, nextMonthBtn;

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            const toastContainer = document.getElementById('toast-container');
            toastContainer.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode === toastContainer) {
                    toastContainer.removeChild(toast);
                }
            }, 3000);
        }

        async function updateStreakDisplay() {
            const streakFire = document.getElementById('streak-fire');
            const streakCount = document.getElementById('streak-count');

            const streakData = getStreakFromStorage();
            const currentStreak = streakData.currentStreak || 0;

            streakCount.textContent = currentStreak;
            streakCount.style.display = 'block';

            if (currentStreak > 0) {
                streakFire.className = 'streak-fire active';
                streakFire.style.animation = 'flame-pulse 0.5s ease-in-out';
                setTimeout(() => {
                    streakFire.style.animation = '';
                }, 500);
            } else {
                streakFire.className = 'streak-fire inactive';
            }
        }

        function updateHealthScoreDisplay(healthScoreData) {
            const healthScoreElement = document.getElementById('health-score');
            const healthLabelElement = document.getElementById('health-label');
            const ringProgress = document.getElementById('ring-progress');
            const verdictElement = document.getElementById('health-verdict');
            const detailsContainer = document.getElementById('health-score-details');

            if (!healthScoreData) {
                healthScoreElement.textContent = '-';
                healthLabelElement.textContent = 'No data';
                verdictElement.textContent = 'Save day data to see your health score';
                ringProgress.style.strokeDashoffset = '565';
                displayEmptyHealthScore();
                return;
            }

            const { overallScore, categories, verdict } = healthScoreData;

            healthScoreElement.textContent = overallScore;
            healthLabelElement.innerHTML = `${verdict.emoji} ${verdict.level}`;

            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (overallScore / 100) * circumference;

            setTimeout(() => {
                ringProgress.style.strokeDashoffset = offset;
            }, 100);

            verdictElement.textContent = verdict.description;
            verdictElement.style.color = verdict.color;

            let detailsHTML = '';
            categories.forEach(category => {
                const categoryColor = getScoreColor(category.score);

                detailsHTML += `
                    <div class="score-category ${category.name.toLowerCase()}-category">
                        <div class="category-header">
                            <div class="category-name">
                                <span class="category-icon">${category.icon}</span>
                                ${category.name} (${category.weight}%)
                            </div>
                            <div class="category-score">${category.score}</div>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${category.score}%; background-color: ${categoryColor};"></div>
                        </div>
                        <div class="score-description">${category.description}</div>
                    </div>
                `;
            });

            detailsContainer.innerHTML = detailsHTML;

            setTimeout(() => {
                const scoreFills = document.querySelectorAll('.score-fill');
                scoreFills.forEach(fill => {
                    const width = fill.style.width;
                    fill.style.width = '0%';
                    setTimeout(() => {
                        fill.style.width = width;
                    }, 100);
                });
            }, 300);
        }

        function displayEmptyHealthScore() {
            const categories = [
                { name: 'Sleep', weight: 40, color: '#2196F3', description: 'Track your sleep', icon: 'üò¥' },
                { name: 'Water', weight: 20, color: '#00BCD4', description: 'Record water intake', icon: 'üíß' },
                { name: 'Activity', weight: 20, color: '#FF9800', description: 'Log activity level', icon: 'üèÉ' },
                { name: 'Mood', weight: 20, color: '#9C27B0', description: 'Track your mood', icon: 'üòä' }
            ];

            let detailsHTML = '';
            categories.forEach(category => {
                detailsHTML += `
                    <div class="score-category ${category.name.toLowerCase()}-category">
                        <div class="category-header">
                            <div class="category-name">
                                <span class="category-icon">${category.icon}</span>
                                ${category.name} (${category.weight}%)
                            </div>
                            <div class="category-score">-</div>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: 0%; background-color: ${category.color};"></div>
                        </div>
                        <div class="score-description">${category.description}</div>
                    </div>
                `;
            });

            document.getElementById('health-score-details').innerHTML = detailsHTML;
        }

        async function loadHealthScore() {
            const healthScoreElement = document.getElementById('health-score');
            const healthLabelElement = document.getElementById('health-label');
            const ringProgress = document.getElementById('ring-progress');
            const verdictElement = document.getElementById('health-verdict');

            try {
                healthScoreElement.textContent = '...';
                healthLabelElement.textContent = 'Calculating...';
                verdictElement.textContent = '';

                const healthScoreData = await calculateCurrentHealthScore();

                if (healthScoreData) {
                    updateHealthScoreDisplay(healthScoreData);
                } else {
                    healthScoreElement.textContent = '-';
                    healthLabelElement.textContent = 'No data';
                    verdictElement.textContent = 'Save today\'s data to see your health score';
                    ringProgress.style.strokeDashoffset = '565';
                    displayEmptyHealthScore();
                }
            } catch (error) {
                console.error('Error loading Health Score:', error);
                healthScoreElement.textContent = '-';
                healthLabelElement.textContent = 'Error';
                verdictElement.textContent = 'Failed to calculate health score';
                ringProgress.style.strokeDashoffset = '565';
                displayEmptyHealthScore();
            }
        }

        async function calculateCurrentHealthScore() {
            try {
                let dayData = {
                    sleepHours: parseFloat(sleepSlider?.value) || null,
                    sleepQuality: getSelectedValue(sleepQualityButtons) || '',
                    waterIntake: getSelectedValue(waterIntakeButtons) || null,
                    mood: parseInt(moodSlider?.value) || null,
                    activityLevel: parseInt(activitySlider?.value) || null,
                    sleepIssues: getSelectedValues(sleepIssuesButtons) || [],
                    dehydrationSymptoms: getSelectedValues(dehydrationButtons) || [],
                    moodRelated: getSelectedValues(moodRelatedButtons) || [],
                    activityIssues: getSelectedValues(activityIssuesButtons) || []
                };

                const today = new Date().toISOString().split('T')[0];
                const savedDayData = getDayFromStorage(today);
                
                if (savedDayData) {
                    dayData = { ...savedDayData, ...dayData };
                }

                return calculateHealthScore(dayData);
            } catch (error) {
                console.error('Error calculating Health Score:', error);
                return null;
            }
        }

        function getSelectedValue(buttonGroup) {
            const selectedButton = buttonGroup?.querySelector('.notion-button.selected');
            return selectedButton ? selectedButton.dataset.value : null;
        }

        function getSelectedValues(buttonGroup) {
            const selectedButtons = buttonGroup?.querySelectorAll('.notion-button.selected') || [];
            return Array.from(selectedButtons).map(btn => btn.dataset.value);
        }

        async function renderCalendar() {
            if (!currentMonthYear) return;

            currentMonthYear.textContent = new Date(currentYear, currentMonth).toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            calendarDays.innerHTML = '';

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                emptyDay.style.visibility = 'hidden';
                calendarDays.appendChild(emptyDay);
            }

            const monthData = getDaysFromStorage();

            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.dataset.day = day;
                dayElement.dataset.month = currentMonth + 1;
                dayElement.dataset.year = currentYear;

                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = monthData[dateKey];

                const hasData = dayData && (
                    dayData.sleepHours !== undefined ||
                    dayData.mood !== undefined ||
                    dayData.activityLevel !== undefined ||
                    dayData.waterIntake !== undefined
                );

                if (hasData) {
                    dayElement.classList.add('saved');
                    const savedIndicator = document.createElement('span');
                    savedIndicator.className = 'saved-day-checkmark';
                    savedIndicator.textContent = '‚úì';
                    savedIndicator.title = 'Day saved';
                    dayElement.appendChild(savedIndicator);
                }

                dayElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectedDay = day;
                    openDayModal(currentYear, currentMonth, day);
                });

                const today = new Date();
                if (currentYear === today.getFullYear() &&
                    currentMonth === today.getMonth() &&
                    day === today.getDate()) {
                    dayElement.classList.add('today');
                }

                calendarDays.appendChild(dayElement);
            }
        }

        function handleButtonClick(event, isMultiSelect) {
            const clickedButton = event.target.closest('.notion-button');
            if (!clickedButton) return;
            const buttonGroup = clickedButton.parentElement;
            const buttons = buttonGroup.querySelectorAll('.notion-button');
            if (!isMultiSelect) buttons.forEach(btn => btn.classList.remove('selected'));
            clickedButton.classList.toggle('selected');
        }

        function checkSleepCondition() {
            const poorSleepSelected = sleepQualityButtons.querySelector('[data-value="poor-sleep"]')?.classList.contains('selected') || false;
            sleepIssuesSection.style.display = poorSleepSelected ? 'block' : 'none';
        }

        function checkWaterCondition() {
            const tooLittleSelected = waterIntakeButtons.querySelector('[data-value="too-little"]')?.classList.contains('selected') || false;
            dehydrationSection.style.display = tooLittleSelected ? 'block' : 'none';
        }

        function checkMoodCondition() {
            const moodValue = parseInt(moodSlider.value);
            moodRelatedSection.style.display = moodValue <= 4 ? 'block' : 'none';
        }

        function checkActivityCondition() {
            const activityValue = parseInt(activitySlider.value);
            activityIssuesSection.style.display = (activityValue <= 3 || activityValue >= 8) ? 'block' : 'none';
        }

        async function openDayModal(year, month, day) {
            try {
                const date = new Date(year, month, day);
                modalDayTitle.textContent = date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = getDayFromStorage(dateStr);

                sleepSlider.value = dayData ? dayData.sleepHours || 7 : 7;
                sleepValueDisplay.textContent = parseFloat(sleepSlider.value).toFixed(1) + ' hrs';
                moodSlider.value = dayData ? dayData.mood || 5 : 5;
                moodValueDisplay.textContent = moodSlider.value;
                activitySlider.value = dayData ? dayData.activityLevel || 5 : 5;
                activityValueDisplay.textContent = activitySlider.value;
                dayNotes.value = dayData ? dayData.notes || '' : '';

                const allButtons = document.querySelectorAll('.notion-button');
                allButtons.forEach(btn => btn.classList.remove('selected'));

                if (dayData) {
                    if (dayData.sleepQuality) {
                        const sleepBtn = sleepQualityButtons.querySelector(`[data-value="${dayData.sleepQuality}"]`);
                        if (sleepBtn) sleepBtn.classList.add('selected');
                    }
                    if (dayData.waterIntake) {
                        const waterBtn = waterIntakeButtons.querySelector(`[data-value="${dayData.waterIntake}"]`);
                        if (waterBtn) waterBtn.classList.add('selected');
                    }
                    if (dayData.sleepIssues && Array.isArray(dayData.sleepIssues)) {
                        dayData.sleepIssues.forEach(issue => {
                            const issueBtn = sleepIssuesButtons.querySelector(`[data-value="${issue}"]`);
                            if (issueBtn) issueBtn.classList.add('selected');
                        });
                    }
                    if (dayData.dehydrationSymptoms && Array.isArray(dayData.dehydrationSymptoms)) {
                        dayData.dehydrationSymptoms.forEach(symptom => {
                            const symptomBtn = dehydrationButtons.querySelector(`[data-value="${symptom}"]`);
                            if (symptomBtn) symptomBtn.classList.add('selected');
                        });
                    }
                    if (dayData.moodRelated && Array.isArray(dayData.moodRelated)) {
                        dayData.moodRelated.forEach(mood => {
                            const moodBtn = moodRelatedButtons.querySelector(`[data-value="${mood}"]`);
                            if (moodBtn) moodBtn.classList.add('selected');
                        });
                    }
                    if (dayData.activityIssues && Array.isArray(dayData.activityIssues)) {
                        dayData.activityIssues.forEach(issue => {
                            const issueBtn = activityIssuesButtons.querySelector(`[data-value="${issue}"]`);
                            if (issueBtn) issueBtn.classList.add('selected');
                        });
                    }
                }

                checkSleepCondition();
                checkWaterCondition();
                checkMoodCondition();
                checkActivityCondition();

                dayModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error opening day modal:', error);
                showToast('Error opening day details');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
        function createNotificationForDay(dayData, date) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const hasNegativeFactors = 
                    dayData.sleepQuality === 'poor-sleep' ||
                    (dayData.sleepIssues && dayData.sleepIssues.length > 0) ||
                    dayData.waterIntake === 'too-little' ||
                    (dayData.dehydrationSymptoms && dayData.dehydrationSymptoms.length > 0) ||
                    (dayData.mood && dayData.mood <= 4) ||
                    (dayData.moodRelated && dayData.moodRelated.length > 0) ||
                    (dayData.activityLevel && (dayData.activityLevel <= 3 || dayData.activityLevel >= 8)) ||
                    (dayData.activityIssues && dayData.activityIssues.length > 0);
                
                if (!hasNegativeFactors) {
                    return false; // –ù–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ inbox.html –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
                if (window.createNotificationFromDayData) {
                    return window.createNotificationFromDayData(dayData, date);
                }
                
                // –ò–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const notification = {
                    id: Date.now(),
                    type: 'symptom_recommendations',
                    message: `Daily Recommendations for ${date}\nSome health improvements needed based on your tracking data.`,
                    sent_at: new Date().toISOString(),
                    read: false
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                const currentNotifications = JSON.parse(localStorage.getItem('health_tracker_notifications') || '[]');
                currentNotifications.unshift(notification);
                localStorage.setItem('health_tracker_notifications', JSON.stringify(currentNotifications));
                
                return true;
            } catch (error) {
                console.error('Error creating notification:', error);
                return false;
            }
        }

        async function saveDayData() {
            if (!selectedDay) return;

            const dayData = {
                sleepHours: parseFloat(sleepSlider.value),
                sleepQuality: getSelectedValue(sleepQualityButtons),
                waterIntake: getSelectedValue(waterIntakeButtons),
                mood: parseInt(moodSlider.value),
                activityLevel: parseInt(activitySlider.value),
                notes: dayNotes.value,
                sleepIssues: getSelectedValues(sleepIssuesButtons),
                dehydrationSymptoms: getSelectedValues(dehydrationButtons),
                moodRelated: getSelectedValues(moodRelatedButtons),
                activityIssues: getSelectedValues(activityIssuesButtons),
                negativeFactors: []
            };

            const negativeButtons = document.querySelectorAll('.notion-button[data-negative="true"].selected');
            negativeButtons.forEach(btn => dayData.negativeFactors.push(btn.dataset.value));

            try {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(selectedDay).padStart(2, '0')}`;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–Ω—å
                if (saveDayToStorage(dateStr, dayData)) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º streak
                    const streakResult = updateStreakInStorage(dateStr);
                    
                    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                    createNotificationForDay(dayData, dateStr);

                    dayModal.style.display = 'none';
                    document.body.style.overflow = '';

                    await renderCalendar();
                    await updateStreakDisplay();
                    await loadHealthScore();

                    let streakMessage = '';
                    if (streakResult.streakIncremented) {
                        streakMessage = `Streak: ${streakResult.currentStreak} days!`;
                    }

                    if (streakMessage) {
                        showToast(streakMessage);
                    } else {
                        showToast('Day saved successfully!');
                    }
                } else {
                    throw new Error('Failed to save day data');
                }
            } catch (error) {
                console.error('Error saving day:', error);
                showToast('Error: ' + error.message);
            }
        }

        // =================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===================
        document.addEventListener('DOMContentLoaded', function () {
            // –ü–æ–ª—É—á–∞–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            currentMonthYear = document.getElementById('current-month-year');
            calendarDays = document.getElementById('calendar-days');
            dayModal = document.getElementById('day-modal');
            modalDayTitle = document.getElementById('modal-day-title');
            closeModal = document.querySelector('.close-modal');

            sleepSlider = document.getElementById('sleep-slider');
            sleepValueDisplay = document.getElementById('sleep-value');
            sleepQualityButtons = document.getElementById('sleep-quality-buttons');

            waterIntakeButtons = document.getElementById('water-intake-buttons');
            moodSlider = document.getElementById('mood-slider');
            moodValueDisplay = document.getElementById('mood-value');
            activitySlider = document.getElementById('activity-slider');
            activityValueDisplay = document.getElementById('activity-value');
            dayNotes = document.getElementById('day-notes');
            saveDayBtn = document.getElementById('save-day-btn');

            sleepIssuesSection = document.getElementById('sleep-issues-section');
            dehydrationSection = document.getElementById('dehydration-section');
            moodRelatedSection = document.getElementById('mood-related-section');
            activityIssuesSection = document.getElementById('activity-issues-section');

            sleepIssuesButtons = document.getElementById('sleep-issues-buttons');
            dehydrationButtons = document.getElementById('dehydration-buttons');
            moodRelatedButtons = document.getElementById('mood-related-buttons');
            activityIssuesButtons = document.getElementById('activity-issues-buttons');

            prevMonthBtn = document.getElementById('prev-month');
            nextMonthBtn = document.getElementById('next-month');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            updateStreakDisplay();
            renderCalendar();
            loadHealthScore();

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π
            closeModal.addEventListener('click', () => {
                dayModal.style.display = 'none';
                document.body.style.overflow = '';
            });

            sleepSlider.addEventListener('input', () => {
                sleepValueDisplay.textContent = parseFloat(sleepSlider.value).toFixed(1) + ' hrs';
            });

            moodSlider.addEventListener('input', () => {
                moodValueDisplay.textContent = moodSlider.value;
                checkMoodCondition();
            });

            activitySlider.addEventListener('input', () => {
                activityValueDisplay.textContent = activitySlider.value;
                checkActivityCondition();
            });

            sleepQualityButtons.addEventListener('click', (e) => {
                handleButtonClick(e, false);
                checkSleepCondition();
            });

            waterIntakeButtons.addEventListener('click', (e) => {
                handleButtonClick(e, false);
                checkWaterCondition();
            });

            [sleepIssuesButtons, dehydrationButtons, moodRelatedButtons, activityIssuesButtons]
                .forEach(group => {
                    if (group) {
                        group.addEventListener('click', (e) => handleButtonClick(e, true));
                    }
                });

            saveDayBtn.addEventListener('click', async () => {
                await saveDayData();
            });

            window.addEventListener('click', (e) => {
                if (e.target === dayModal) {
                    dayModal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });

            prevMonthBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            // Health Score —Å–æ–±—ã—Ç–∏—è
            const healthScoreTitle = document.getElementById('health-score-title');
            const healthScoreToggle = document.getElementById('health-score-toggle');
            const healthScoreDetails = document.getElementById('health-score-details');

            if (healthScoreTitle && healthScoreDetails) {
                const isCollapsed = localStorage.getItem('healthScoreDetailsCollapsed') === 'true';
                if (isCollapsed) {
                    healthScoreDetails.classList.add('collapsed');
                    healthScoreToggle.classList.add('collapsed');
                }

                healthScoreTitle.addEventListener('click', function () {
                    const isCollapsed = healthScoreDetails.classList.contains('collapsed');
                    if (isCollapsed) {
                        healthScoreDetails.classList.remove('collapsed');
                        healthScoreToggle.classList.remove('collapsed');
                        localStorage.setItem('healthScoreDetailsCollapsed', 'false');
                    } else {
                        healthScoreDetails.classList.add('collapsed');
                        healthScoreToggle.classList.add('collapsed');
                        localStorage.setItem('healthScoreDetailsCollapsed', 'true');
                    }
                });
            }

            // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ Health Score
            if (healthScoreTitle) {
                healthScoreTitle.addEventListener('dblclick', () => {
                    loadHealthScore();
                    showToast('Health Score recalculated');
                });
            }
        });
    </script>
</body>
</html>
